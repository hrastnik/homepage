---
import * as cheerio from "cheerio";

async function getPineta() {
  const $ = await cheerio.fromURL(
    "https://www.pizzeria-pineta-labin.com.hr/restauracja/pizzeria-pineta-labin"
  );
  const menu = $("#menu-dnevna-ponuda-marendi");
  const dishElementList = menu.find("li");

  const dishList = dishElementList
    .map((_index, element) => {
      const elementCheerio = $(element);
      return {
        imageURL: elementCheerio.find("img").attr("src"),
        price: elementCheerio.find(".add-button").text().trim(),
        name: elementCheerio.find("h4").text().trim(),
      };
    })
    .toArray();

  return { dishList };
}

async function getLabineca() {
  const response = await fetch("https://www.facebook.com/labineca/", {
    headers: {
      accept: "text/html",
      "cache-control": "max-age=0",
      "sec-fetch-site": "same-origin",
    },
  });
  const html = await response.text();
  const imageRegex = /{"uri":[^}]*jpg[^}]*}/gm;
  const imageListRaw = html.match(imageRegex) ?? [];
  const imageListParsed = imageListRaw.map((image) => JSON.parse(image));

  const postImageList = imageListParsed
    .filter((image) => {
      return "width" in image && "height" in image && "uri" in image;
    })
    .filter((image) => {
      return 1600 < image.width && image.width < 1650;
    }) as { uri: string; width: number; height: number }[];

  const labinecaURI = postImageList[0]?.uri;

  return {
    menuURI: labinecaURI,
  };
}

const [pineta, labineca] = await Promise.allSettled([
  getPineta(),
  getLabineca(),
]);

---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Astro description" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Local Favorites</title>
  </head>
  <body class="h-screen max-h-screen">
    <div
      class="flex flex-col h-screen max-h-screen w-screen bg-gray-100 text-gray-800 p-8"
    >
      {/* Header */}
      <header class="text-center mb-6">
        <h1 class="text-4xl font-bold text-gray-900">Local Favorites</h1>
        <p class="text-lg text-gray-600">
          Discover the best dishes and menus at Pineta and Labineca.
        </p>
      </header>

      {/* Main Content */}
      <div class="flex flex-1 justify-between gap-8">
        {/* Pineta Section */}
        <div class="flex flex-1 flex-col bg-white shadow-lg rounded-lg p-6">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Pineta</h2>
          <div class="space-y-4">
            {
              pineta.status === "fulfilled" &&
                pineta.value.dishList.map((dish) => (
                  <div class="flex items-center bg-gray-50 p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    {dish.imageURL ? (
                      <img
                        src={dish.imageURL}
                        alt={dish.name}
                        class="w-16 h-16 rounded-md object-cover mr-4"
                      />
                    ) : (
                      <div class="w-16 h-16 flex items-center justify-center bg-gray-200 text-gray-400 rounded-md mr-4">
                        No Image
                      </div>
                    )}
                    <div class="flex-1">
                      <h3 class="text-lg font-medium text-gray-700">
                        {dish.name}
                      </h3>
                      <p class="text-gray-500">{dish.price}</p>
                    </div>
                  </div>
                ))
            }
          </div>
        </div>

        {/* Labineca Section */}
        <div class="flex flex-col flex-1 bg-white shadow-lg rounded-lg p-6">
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">Labineca</h2>
          {
            labineca.status === "fulfilled" && labineca.value.menuURI ? (
              <div class="flex-1 rounded-lg shadow-md overflow-hidden relative">
                <img
                  src={labineca.value.menuURI}
                  alt="Labineca Menu"
                  class="absolute top-0 left-0 w-full h-full object-contain"

                />
              </div>
            ) : (
              <p class="text-gray-500 text-center">Menu image unavailable</p>
            )
          }
        </div>
      </div>

      {/* Footer */}
      <footer class="text-center mt-6">
        <p class="text-sm text-gray-500">
          Bon App√©tit! Visit these restaurants for a delightful meal.
        </p>
      </footer>
    </div>
  </body>
</html>
